<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="admin">

 	<select id="select" resultType="AdminDTO" parameterType="AdminDTO">
 		select admin_number , admin_id, admin_password, admin_name, admin_team from tbl_admin 
		where admin_id = #{adminId} and admin_password = #{adminPassword}
 	</select>

	<select id="getTotal" resultType="_int">
		select count(user_number) from tbl_user
	</select>
	
	<select id="userInfo" resultType="UserManageVO" parameterType="map">
		select u.user_number , g.grade_name , u.user_nickname , u.user_date  
		from tbl_grade g join tbl_user u 
		on g.grade_number = u.grade_number 
		order by u.user_number desc
	</select>

	<select id="userDetail" resultType="UserDetailVO" parameterType="_int">
		SELECT 
 		 u.user_number, g.grade_name, u.user_nickname, u.user_name,
 		 u.user_email, u.user_date, u.user_phone,
 		 COUNT(DISTINCT s.story_number) AS story_count,
 		 COUNT(DISTINCT r.reply_number) AS reply_count,
 		 COUNT(DISTINCT f1.follow_number) AS follower_count,
 		 COUNT(DISTINCT f2.follow_number) AS following_count
		FROM tbl_user u 
 		 LEFT JOIN tbl_grade g ON u.grade_number = g.grade_number
		 LEFT JOIN tbl_story s ON u.user_number = s.user_number
 		 LEFT JOIN tbl_story_reply r ON u.user_number = r.user_number
 		 LEFT JOIN tbl_follow f1 ON u.user_number = f1.user_to
  		LEFT JOIN tbl_follow f2 ON u.user_number = f2.user_from
		WHERE u.user_number = #{userNumber}
		GROUP BY u.user_number
	</select>
	
	<select id="gosuInfo" resultType="GosuManageVO" parameterType="map">
		select 
		u.user_number,
		g.gosu_number, 
		u.user_nickname,
		count(distinct q.question_number) as question_count, 
		count(distinct qr.reply_number) as answer_count,
		group_concat(distinct f.field_name separator ', ') as field_names
		from tbl_gosu g
		join tbl_gosu_field gf on g.gosu_number = gf.gosu_number
		join tbl_field f on gf.field_number = f.field_number
		join tbl_user u on g.user_number = u.user_number
		left outer join tbl_question q on g.gosu_number = q.gosu_number
		left outer join tbl_question_reply qr on g.gosu_number = qr.gosu_number
		where grade_number = 500
		group by g.gosu_number
	</select>
	
	<select id="gosuDetail" resultType="GosuDetailVO" parameterType="_int">
			WITH gosu_stats AS (
  		SELECT 
 		   u.user_number,
 		   g.gosu_number, 
 		   u.user_nickname,
 		   COUNT(DISTINCT q.question_number) AS question_count, 
 		   COUNT(DISTINCT qr.reply_number) AS answer_count,
 		   GROUP_CONCAT(DISTINCT f.field_name SEPARATOR ', ') AS gosu_fields
 		 FROM tbl_gosu g
 		 JOIN tbl_gosu_field gf ON g.gosu_number = gf.gosu_number
		  JOIN tbl_field f ON gf.field_number = f.field_number
 		 JOIN tbl_user u ON g.user_number = u.user_number
 		 LEFT OUTER JOIN tbl_question q ON g.gosu_number = q.gosu_number
 		 LEFT OUTER JOIN tbl_question_reply qr ON g.gosu_number = qr.gosu_number
		  WHERE u.grade_number = 500
 		 GROUP BY g.gosu_number),
		user_stats AS (
		  SELECT 
  		  u.user_number, 
 		   g.grade_name, 
  		  u.user_nickname, 
  		  u.user_name,
  		  u.user_email, 
  		  u.user_date, 
  		  u.user_phone,
  		  COUNT(DISTINCT s.story_number) AS story_count,
  		  COUNT(DISTINCT r.reply_number) AS reply_count,
  		  COUNT(DISTINCT f1.follow_number) AS follower_count,
   		 COUNT(DISTINCT f2.follow_number) AS following_count
 		 FROM tbl_user u 
 		 LEFT JOIN tbl_grade g ON u.grade_number = g.grade_number
 		 LEFT JOIN tbl_story s ON u.user_number = s.user_number
  		LEFT JOIN tbl_story_reply r ON u.user_number = r.user_number
  		LEFT JOIN tbl_follow f1 ON u.user_number = f1.user_to
 		 LEFT JOIN tbl_follow f2 ON u.user_number = f2.user_from
 		 GROUP BY u.user_number
		)
		SELECT user_stats.user_number, 
		user_stats.grade_name,
		user_stats.user_nickname,
		user_stats.user_name,
		user_stats.user_phone,
		user_stats.user_email,
		user_stats.user_date,
		user_stats.story_count,
		user_stats.reply_count,
		user_stats.follower_count,
		user_stats.following_count,
		gosu_stats.gosu_number,
		gosu_stats.gosu_fields,
		gosu_stats.question_count,
		gosu_stats.answer_count
		FROM gosu_stats 
		JOIN user_stats ON gosu_stats.user_number = user_stats.user_number AND gosu_stats.user_nickname = user_stats.user_nickname
		where user_stats.user_number = #{userNumber};
	</select>
	
	<select id="kill" parameterType="_int">
		delete from tbl_user where user_number = #{userNumber};
	</select>
	
	<select id="down" parameterType="_int">
		update tbl_user set grade_number = 100	where user_number = #{userNumber};
	</select>
	
</mapper>